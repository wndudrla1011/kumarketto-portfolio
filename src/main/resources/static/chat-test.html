<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì¿ ë§ˆì¼“í†  - ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ë§: ê°€ë…ì„±ê³¼ ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤. */
        body {
          font-family: "Malgun Gothic", sans-serif;
          margin: 0;
          padding: 20px;
          background-color: #f4f4f9;
          display: flex;
          flex-direction: column;
          align-items: center;
        }
        .container {
          width: 100%;
          max-width: 800px;
          background-color: white;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
          padding: 20px;
          display: flex;
          flex-direction: column;
        }
        h1, h2 {
          text-align: center;
          color: #333;
        }
        .hidden { display: none; }
        input[type="text"] {
          padding: 8px;
          border-radius: 4px;
          border: 1px solid #ccc;
          width: 200px;
        }
        button {
          padding: 8px 15px;
          border: none;
          background-color: #5c67f2;
          color: white;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        }
        button:hover { background-color: #4a54c2; }
        #chat-window {
          height: 500px;
          border: 1px solid #ccc;
          border-radius: 5px;
          overflow-y: scroll;
          padding: 10px;
          margin-bottom: 10px;
          background-color: #e5efff;
          flex-grow: 1; /* ì±„íŒ…ì°½ì´ ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
        }
        .message {
          padding: 8px;
          margin-bottom: 8px;
          border-radius: 7px;
          max-width: 70%;
          word-wrap: break-word;
        }
        .message.sent {
          background-color: #fcc421;
          margin-left: auto;
          text-align: right;
        }
        .message.received {
          background-color: #ffffff;
          margin-right: auto;
          text-align: left;
        }
        .message-meta {
          font-size: 0.8em;
          color: #555;
          margin-top: 5px;
        }
        .message img {
          max-width: 100%;
          border-radius: 5px;
          margin-top: 5px;
        }
        #chat-input-area { display: flex; }
        #message-input {
          flex-grow: 1;
          margin-right: 10px;
        }
        #login-info {
          text-align: right;
          padding: 5px;
          color: #555;
          font-size: 0.9em;
          margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ì‹¤ì‹œê°„ ì±„íŒ… ğŸ’¬</h1>

    <div id="login-info">
        <strong>ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:</strong> <span id="current-user-id"></span>
    </div>

    <div id="chat-section">
        <h2>
            ìƒí’ˆ #<span id="product-id-display"></span> / ì±„íŒ…ë°© #<span
                id="chat-id-display"
        ></span>
        </h2>
        <div id="chat-window"></div>
        <div id="chat-input-area">
            <input
                    type="text"
                    id="message-input"
                    placeholder="ë©”ì‹œì§€ ë˜ëŠ” ì´ë¯¸ì§€ URL ì…ë ¥..."
                    onkeydown="handleEnterKey(event)"
            />
            <button id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>
</div>

<script>
    // --- ì „ì—­ ë³€ìˆ˜: ì›¹ì†Œì¼“ ê°ì²´, í˜„ì¬ ì‚¬ìš©ì ID, ì±„íŒ…ë°© ID ë“±ì„ ì €ì¥í•©ë‹ˆë‹¤. ---
    let websocket = null;
    let currentUserId = null;
    let currentChatId = null;
    let currentProductId = null;

    // --- í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ì´ˆê¸°í™” í•¨ìˆ˜ ---
    window.onload = async function() {
        // 1. URL ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ ì±„íŒ…ë°© IDì™€ ìƒí’ˆ IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const urlParams = new URLSearchParams(window.location.search);
        currentChatId = parseInt(urlParams.get('chatId'));
        currentProductId = parseInt(urlParams.get('productId'));

        // í•„ìˆ˜ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì‹¤í–‰ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
        if (!currentChatId || !currentProductId) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. ì±„íŒ… ëª©ë¡ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            // location.href = '/chat/list'; // ì±„íŒ… ëª©ë¡ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜
            return;
        }

        // 2. í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì IDë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        // [ì¤‘ìš”] ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì„œë²„ APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì„¸ì…˜ì— ì €ì¥ëœ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤.
        // ì˜ˆ: const response = await fetch('/api/user/me'); const user = await response.json(); currentUserId = user.id;
        // ì—¬ê¸°ì„œëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì„ì‹œë¡œ prompt ì°½ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        currentUserId = prompt("í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë‹¹ì‹ ì˜ ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: user203 ë˜ëŠ” user204)");
        if (!currentUserId) {
            alert("ì‚¬ìš©ì IDê°€ ì—†ì–´ ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // 3. UIì— í˜„ì¬ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
        document.getElementById("product-id-display").textContent = currentProductId;
        document.getElementById("chat-id-display").textContent = currentChatId;
        document.getElementById("current-user-id").textContent = currentUserId;

        // 4. ì›¹ì†Œì¼“ ì—°ê²°ì„ ì‹œì‘í•©ë‹ˆë‹¤.
        connectWebSocket();

        // 5. (ì„ íƒì‚¬í•­) ì—¬ê¸°ì— ê³¼ê±° ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // ì˜ˆ: fetchPastMessages(currentChatId);
    };


    /**
     * ì›¹ì†Œì¼“ ì—°ê²°ì„ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
     * ì„œë²„ì™€ ì‹¤ì‹œê°„ í†µì‹  ì±„ë„ì„ ì—½ë‹ˆë‹¤.
     */
    function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const host = window.location.host;
        const socketUrl = `${protocol}//${host}/ws/chat`;

        websocket = new WebSocket(socketUrl);

        // ì—°ê²° ì„±ê³µ ì‹œ
        websocket.onopen = function () {
            console.log("WebSocket ì—°ê²° ì„±ê³µ!");
            displaySystemMessage(`ì±„íŒ…ë°© #${currentChatId}ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
        };

        // ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ
        websocket.onmessage = function (event) {
            console.log("ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
            const message = JSON.parse(event.data);

            // í˜„ì¬ ë³´ê³  ìˆëŠ” ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ì¼ ê²½ìš°ì—ë§Œ í™”ë©´ì— í‘œì‹œ
            if (message.chatId === currentChatId) {
                displayMessage(message);
            } else {
                // ë‹¤ë¥¸ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ì´ë©´ ì•Œë¦¼ë§Œ ë„ì›€
                alert(`ë‹¤ë¥¸ ì±„íŒ…ë°© #${message.chatId}ì— ìƒˆ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`);
            }
        };

        // ì—°ê²° ì¢…ë£Œ ì‹œ
        websocket.onclose = function () {
            console.log("WebSocket ì—°ê²°ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.");
            displaySystemMessage("ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
        };

        // ì—ëŸ¬ ë°œìƒ ì‹œ
        websocket.onerror = function (error) {
            console.error("WebSocket ì˜¤ë¥˜ ë°œìƒ:", error);
            displaySystemMessage("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
        };
    }

    /**
     * ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
     * ì…ë ¥ í•„ë“œì˜ ë‚´ìš©ì„ JSON í˜•ì‹ìœ¼ë¡œ ë§Œë“¤ì–´ ì›¹ì†Œì¼“ì„ í†µí•´ ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
     */
    function sendMessage() {
        if (!websocket || websocket.readyState !== WebSocket.OPEN) {
            alert("WebSocketì´ ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        const messageInput = document.getElementById("message-input");
        const content = messageInput.value.trim();

        if (content === "") return; // ë‚´ìš©ì´ ì—†ìœ¼ë©´ ë³´ë‚´ì§€ ì•ŠìŒ

        let messageType = "TEXT";
        let imageUrl = null;

        // ê°„ë‹¨í•œ URL ê°ì§€ ë¡œì§
        if (content.startsWith("http") && (content.endsWith(".png") || content.endsWith(".jpg") || content.endsWith(".jpeg") || content.endsWith(".gif"))) {
            messageType = "IMAGE";
            imageUrl = content;
        }

        // ì„œë²„ì˜ ChatMessageDTO í˜•ì‹ì— ë§ëŠ” JSON ê°ì²´ë¥¼ ìƒì„±
        const messagePayload = {
            chatId: currentChatId,
            content: messageType === "TEXT" ? content : null,
            imageUrl: imageUrl,
            messageType: messageType,
        };

        // JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì„œë²„ì— ì „ì†¡
        websocket.send(JSON.stringify(messagePayload));

        // ì‚¬ìš©ì ê²½í—˜ì„ ìœ„í•´ ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ë¥¼ ì¦‰ì‹œ í™”ë©´ì— í‘œì‹œ (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
        const optimisticMessage = {
            senderId: currentUserId, // ChatMessageSendDTO í˜•ì‹ì— ë§ì¶¤
            content: messagePayload.content,
            imageUrl: messagePayload.imageUrl,
            createdDate: new Date().toISOString(),
        };
        displayMessage(optimisticMessage);

        messageInput.value = ""; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        messageInput.focus();
    }

    /**
     * ì—”í„° í‚¤ ì…ë ¥ ì²˜ë¦¬ í•¨ìˆ˜
     */
    function handleEnterKey(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    }

    /**
     * ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ ì±„íŒ…ì°½ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
     * @param {object} msg - ì„œë²„ë¡œë¶€í„° ë°›ì€ ë©”ì‹œì§€ ê°ì²´ (ChatMessageSendDTO í˜•ì‹)
     */
    function displayMessage(msg) {
        const chatWindow = document.getElementById("chat-window");
        const messageElement = document.createElement("div");

        // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€, ìƒëŒ€ë°©ì´ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€ êµ¬ë¶„í•˜ì—¬ í´ë˜ìŠ¤ ì ìš©
        const messageTypeClass = msg.senderId === currentUserId ? "sent" : "received";
        messageElement.classList.add("message", messageTypeClass);

        let messageContentHTML = "";
        if (msg.content) {
            messageContentHTML += `<div>${msg.content}</div>`;
        }
        if (msg.imageUrl) {
            messageContentHTML += `<div><img src="${msg.imageUrl}" alt="ì „ì†¡ëœ ì´ë¯¸ì§€"></div>`;
        }

        const sentTime = new Date(msg.createdDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageContentHTML += `<div class="message-meta">${msg.senderId} - ${sentTime}</div>`;

        messageElement.innerHTML = messageContentHTML;
        chatWindow.appendChild(messageElement);

        // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ë§¨ ì•„ë˜ë¡œ ì´ë™
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /**
     * ì‹œìŠ¤í…œ ë©”ì‹œì§€(ì—°ê²°, ì¢…ë£Œ ë“±)ë¥¼ ì±„íŒ…ì°½ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
     * @param {string} text - í‘œì‹œí•  ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë‚´ìš©
     */
    function displaySystemMessage(text) {
        const chatWindow = document.getElementById("chat-window");
        const systemMessage = document.createElement("div");
        systemMessage.textContent = text;
        systemMessage.style.textAlign = "center";
        systemMessage.style.color = "#888";
        systemMessage.style.fontSize = "0.9em";
        systemMessage.style.margin = "10px 0";
        chatWindow.appendChild(systemMessage);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
</script>
</body>
</html>