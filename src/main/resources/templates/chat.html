<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚¯ãƒã‚±ãƒƒãƒˆ - ãƒãƒ£ãƒƒãƒˆ</title>
  <style>
    /* --- ìŠ¤íƒ€ì¼(CSS) ë¶€ë¶„ì€ ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë¯€ë¡œ ìƒëµí•©ë‹ˆë‹¤ --- */
    @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap");
    html,
    body {
      height: 100%;
      margin: 0;
      font-family: "Noto Sans KR", sans-serif;
      background-color: #f8f9fa;
      overflow: hidden;
      color: #212529;
    }
    .main-container {
      display: flex;
      height: 100vh;
      width: 100%;
    }
    #room-list-panel {
      width: 350px;
      border-right: 1px solid #dee2e6;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    #room-list-header {
      padding: 24px 20px;
      font-size: 20px;
      font-weight: 700;
      border-bottom: 1px solid #e9ecef;
    }
    #chat-room-list {
      overflow-y: auto;
      flex-grow: 1;
    }
    .room-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .room-item:hover {
      background-color: #f8f9fa;
    }
    .room-item.active {
      background-color: #f5efe6;
    }
    .room-item-img {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 15px;
      background-color: #e9ecef;
    }
    .room-item-details {
      display: flex;
      position: relative;
      flex-direction: column;
      justify-content: center;
      flex-grow: 1;
      overflow: hidden;
    }
    .room-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .opponent-nickname {
      font-weight: 500;
      font-size: 15px;
    }
    .last-message-time {
      font-size: 12px;
      color: #868e96;
      flex-shrink: 0;
      margin-left: 8px;
    }
    .last-message-content {
      font-size: 14px;
      color: #495057;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 4px;
    }
    #chat-panel {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      background-color: #f8f9fa;
    }
    #chat-panel-header {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid #dee2e6;
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    #header-product-image {
      width: 45px;
      height: 45px;
      border-radius: 6px;
      object-fit: cover;
      margin-right: 15px;
    }
    #header-product-details {
      flex-grow: 1;
    }
    #header-product-title {
      font-size: 16px;
      font-weight: 700;
    }
    #header-product-price {
      font-size: 15px;
      color: #b38b6d;
      font-weight: 700;
    }
    #login-info {
      font-size: 12px;
      color: #868e96;
      text-align: right;
    }
    #chat-window {
      flex-grow: 1;
      overflow-y: scroll;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    #chat-placeholder {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #adb5bd;
      font-size: 18px;
    }
    #chat-input-area {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      background-color: #fff;
      border-top: 1px solid #dee2e6;
    }
    #image-upload-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 24px;
      padding: 0 12px 0 4px;
      color: #868e96;
      transition: color 0.2s;
    }
    #image-upload-btn:hover {
      color: #495057;
    }
    #message-input {
      flex-grow: 1;
      margin-right: 10px;
      padding: 12px 18px;
      border-radius: 22px;
      border: 1px solid #ced4da;
      font-size: 15px;
    }
    #message-input:focus {
      outline: none;
      border-color: #b38b6d;
    }
    #send-btn {
      padding: 0 20px;
      border: none;
      background-color: #b38b6d;
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    #send-btn:hover {
      background-color: #936a49;
    }
    .message-container {
      display: flex;
      align-items: flex-end;
      margin-bottom: 12px;
      max-width: 70%;
    }
    .message-container.sent {
      align-self: flex-end;
    }
    .message-container.received {
      align-self: flex-start;
    }
    .message {
      padding: 10px 15px;
      border-radius: 18px;
      word-break: break-word;
      line-height: 1.5;
    }
    .message.sent {
      background-color: #eaddca;
      border-bottom-right-radius: 4px;
    }
    .message.received {
      background-color: #ffffff;
      border: 1px solid #e9ecef;
      border-bottom-left-radius: 4px;
    }
    .message img {
      max-width: 250px;
      max-height: 250px;
      border-radius: 12px;
      display: block;
    }
    .message.sent img,
    .message.received img {
      padding: 0;
    }
    .message-status {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin: 0 8px;
      flex-shrink: 0;
    }
    .unread-indicator {
      font-size: 12px;
      font-weight: bold;
      color: #e4a11b;
      margin-bottom: 2px;
    }
    .message-time {
      font-size: 11px;
      color: #868e96;
      flex-shrink: 0;
    }
    .unread-dot {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      width: 9px;
      height: 9px;
      background-color: #e4a11b;
      border-radius: 50%;
      border: 1px solid #fff;
    }
    .transaction-request {
      background-color: #fff8e1;
      border: 1px solid #ffecb3;
      border-radius: 8px;
      padding: 15px;
      margin: 10px auto;
      width: 80%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .transaction-request p {
      margin: 0 0 12px 0;
      font-size: 15px;
      color: #5d4037;
    }
    .request-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      margin: 0 5px;
      transition: background-color 0.2s;
    }
    .btn-approve {
      background-color: #28a745;
      color: white;
    }
    .btn-approve:hover {
      background-color: #218838;
    }
    .btn-reject {
      background-color: #dc3545;
      color: white;
    }
    .btn-reject:hover {
      background-color: #c82333;
    }
    /* [ì¶”ê°€] í—¤ë” ë²„íŠ¼ì„ ìœ„í•œ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .header-action-btn {
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      color: #333;
      font-size: 14px;
      font-weight: 500;
      margin: 0 5px;
    }
    .header-action-btn:hover {
      background-color: #e0e0e0;
    }

    /* [ì¶”ê°€] ë‚˜ê°€ê¸° ë²„íŠ¼ì„ ìœ„í•œ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
    #leave-chat-btn {
      background-color: #ffdddd;
      border-color: #ff9999;
    }
    #leave-chat-btn:hover {
      background-color: #ffcccc;
    }
  </style>
</head>
<body>
<div class="main-container">
  <div id="room-list-panel">
    <div id="room-list-header">ãƒãƒ£ãƒƒãƒˆ</div>
    <div id="chat-room-list"></div>
  </div>
  <div id="chat-panel">
    <div id="chat-panel-header" style="display: none">
      <a href="/" class="header-action-btn">ãƒ¡ã‚¤ãƒ³ã¸</a>
      <img id="header-product-image" src="" alt="å•†å“ç”»åƒ" />
      <div id="header-product-details">
        <div id="header-product-title"></div>
        <div id="header-product-price"></div>
      </div>
      <div id="login-info">
        <strong><span id="current-user-id"></span></strong> æ§˜ã§ãƒ­ã‚°ã‚¤ãƒ³ä¸­
      </div>
      <button id="leave-chat-btn" class="header-action-btn">é€€å‡º</button>
    </div>
    <div id="chat-window">
      <div id="chat-placeholder">
        <p>å·¦å´ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ ğŸ»</p>
      </div>
    </div>
    <div id="chat-input-area" style="display: none">
      <button id="image-upload-btn" onclick="triggerImageUpload()">
        â•
      </button>
      <input
              type="file"
              id="image-file-input"
              accept="image/*"
              style="display: none"
              onchange="handleImageSelect(event)"
      />
      <input
              type="text"
              id="message-input"
              placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
              onkeydown="handleEnterKey(event)"
      />
      <button id="send-btn" onclick="sendTextMessage()">é€ä¿¡</button>
    </div>
  </div>
</div>

<script>
  let websocket = null;
  let currentUserId = null;
  let currentChatId = null;
  let loadRequestCounter = 0;

  // window.onload, resetChatPanel, loadChatRooms, selectChatRoom, loadPastMessages, connectWebSocket, updateChatRoomList,
  // triggerImageUpload, handleImageSelect, sendImageMessage, sendTextMessage, handleEnterKey, formatMessageTime í•¨ìˆ˜ë“¤ì€
  // ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë¯€ë¡œ ìƒëµí•©ë‹ˆë‹¤.
  window.onload = async function () {
    try {
      const response = await fetch(`${window.location.origin}/api/user/me`);
      if (!response.ok) {
        alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
        location.href = `${window.location.origin}/member/signIn`;
        return;
      }
      const user = await response.json();
      currentUserId = user.userId;
      document.getElementById("current-user-id").textContent =
        currentUserId;
      const urlParams = new URLSearchParams(window.location.search);
      const chatIdFromUrl = urlParams.get("chatId");
      await loadChatRooms(chatIdFromUrl);
      connectWebSocket();
      addLeaveButtonListener();
    } catch (error) {
      console.error("åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
    }
  };
  function resetChatPanel() {
    currentChatId = null;
    const chatPanelHeader = document.getElementById("chat-panel-header");
    if (chatPanelHeader) chatPanelHeader.style.display = "none";
    const chatPlaceholder = document.getElementById("chat-placeholder");
    if (chatPlaceholder) chatPlaceholder.style.display = "flex";
    const chatInputArea = document.getElementById("chat-input-area");
    if (chatInputArea) chatInputArea.style.display = "none";
    const chatWindow = document.getElementById("chat-window");
    if (chatWindow) chatWindow.innerHTML = "";
    const currentActive = document.querySelector(".room-item.active");
    if (currentActive) currentActive.classList.remove("active");
  }
  async function loadChatRooms(chatIdToSelect) {
    try {
      const response = await fetch(
        `${window.location.origin}/api/chat/my-rooms`
      );
      if (!response.ok) {
        throw new Error("ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
      const chatRooms = await response.json();
      const listElement = document.getElementById("chat-room-list");
      listElement.innerHTML = "";
      chatRooms.sort(
        (a, b) => new Date(b.lastMessageAt) - new Date(a.lastMessageAt)
      );
      chatRooms.forEach((room) => {
        const roomElement = document.createElement("div");
        roomElement.className = "room-item";
        roomElement.dataset.chatId = room.chatId;
        roomElement.dataset.productTitle = room.productTitle;
        roomElement.dataset.productPrice =
          room.productPrice.toLocaleString("ja-JP") + "å††";
        roomElement.dataset.opponentNickname = room.opponentNickname;
        roomElement.dataset.productImageUrl = room.productImageUrl;
        roomElement.onclick = () => selectChatRoom(roomElement);
        const lastTime = new Date(room.lastMessageAt);
        const timeString =
          lastTime.getHours().toString().padStart(2, "0") +
          ":" +
          lastTime.getMinutes().toString().padStart(2, "0");
        const placeholderImg =
          "https://placehold.co/100x100/E9ECEF/ADB5BD?text=Kumarket";
        roomElement.innerHTML = ` <img class="room-item-img" src="${
          room.productImageUrl || placeholderImg
        }" alt="å•†å“ç”»åƒ" onerror="this.src='${placeholderImg}'"> <div class="room-item-details"> ${
          room.hasUnreadMessages ? '<span class="unread-dot"></span>' : ""
        } <div class="room-item-header"> <span class="opponent-nickname">${
          room.opponentNickname
        }</span> <span class="last-message-time">${timeString}</span> </div> <div class="last-message-content">${
          room.lastMessageContent
        }</div> </div> `;
        listElement.appendChild(roomElement);
      });
      if (chatIdToSelect) {
        const roomToSelect = document.querySelector(
          `.room-item[data-chat-id='${chatIdToSelect}']`
        );
        if (roomToSelect) {
          selectChatRoom(roomToSelect);
        } else {
          resetChatPanel();
        }
      } else {
        resetChatPanel();
      }
    } catch (error) {
      console.error("ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    }
  }
  async function selectChatRoom(roomElement) {
    const currentActive = document.querySelector(".room-item.active");
    if (currentActive) currentActive.classList.remove("active");
    roomElement.classList.add("active");
    currentChatId = parseInt(roomElement.dataset.chatId);
    loadRequestCounter++;
    const currentRequestVersion = loadRequestCounter;
    const dot = roomElement.querySelector(".unread-dot");
    if (dot) dot.remove();
    try {
      await fetch(
        `${window.location.origin}/api/chat/${currentChatId}/read`,
        {
          method: "POST",
        }
      );
    } catch (error) {
      console.error("æ—¢èª­å‡¦ç†APIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    }
    const placeholderImg =
      "https://placehold.co/100x100/E9ECEF/ADB5BD?text=Kumarket";
    const chatPanelHeader = document.getElementById("chat-panel-header");
    if (chatPanelHeader) {
      document.getElementById("header-product-image").src =
        roomElement.dataset.productImageUrl || placeholderImg;
      document.getElementById("header-product-image").onerror =
        function () {
          this.src = placeholderImg;
        };
      const productTitleEl = document.getElementById(
        "header-product-title"
      );
      // product-idë¥¼ datasetì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •
      const productId = roomElement.dataset.productId || "#";
      productTitleEl.innerHTML = `
    <a href="/product/detail/${productId}" style="text-decoration: none; color: inherit;">
        ${roomElement.dataset.productTitle}
    </a>
  `;
      document.getElementById("header-product-price").textContent =
        roomElement.dataset.productPrice;
      chatPanelHeader.style.display = "flex";
    }
    const chatPlaceholder = document.getElementById("chat-placeholder");
    if (chatPlaceholder) chatPlaceholder.style.display = "none";
    const chatInputArea = document.getElementById("chat-input-area");
    if (chatInputArea) chatInputArea.style.display = "flex";
    document.getElementById("chat-window").innerHTML = "";
    await loadPastMessages(currentChatId, currentRequestVersion);


  }
  async function loadPastMessages(chatId, requestVersion) {
    try {
      const response = await fetch(
        `${window.location.origin}/api/chat/${chatId}/messages`
      );
      const pastMessages = await response.json();
      if (requestVersion !== loadRequestCounter) {
        console.log(
          `[é‡è¤‡é˜²æ­¢] å‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ(${requestVersion})ã‚’ç„¡è¦–ã—ã¾ã™ã€‚æœ€æ–°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ${loadRequestCounter}`
        );
        return;
      }
      for (const message of pastMessages) {
        displayMessage(message);
      }
    } catch (error) {
      console.error("éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
    }
  }
  function connectWebSocket() {
    if (websocket && websocket.readyState === WebSocket.OPEN) {
      return;
    }
    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const host = window.location.host;
    websocket = new WebSocket(`${protocol}//${host}/ws/chat`);
    websocket.onmessage = (event) => {
      console.log("[WebSocket] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:", event.data);
      const data = JSON.parse(event.data);
      if (data.type === "MESSAGES_READ") {
        const indicators = document.querySelectorAll(
          `.unread-indicator[data-chat-id='${data.chatId}']`
        );
        indicators.forEach((indicator) => indicator.remove());
      } else if (data.chatId === currentChatId) {
        displayMessage(data);
        try {
          fetch(
            `${window.location.origin}/api/chat/${currentChatId}/read`,
            { method: "POST" }
          );
        } catch (error) {
          console.error(
            "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ—¢èª­å‡¦ç†APIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ:",
            error
          );
        }
      } else {
        updateChatRoomList(data);
      }
    };
    websocket.onclose = () =>
      console.log("WebSocketæ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚");
    websocket.onerror = (error) =>
      console.error("WebSocketã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
  }
  function updateChatRoomList(msg) {
    const roomList = document.getElementById("chat-room-list");
    const roomElement = roomList.querySelector(
      `.room-item[data-chat-id='${msg.chatId}']`
    );
    if (roomElement) {
      const lastMessageContent = roomElement.querySelector(
        ".last-message-content"
      );
      if (lastMessageContent) lastMessageContent.textContent = msg.content;
      const lastMessageTime =
        roomElement.querySelector(".last-message-time");
      if (lastMessageTime)
        lastMessageTime.textContent = formatMessageTime(msg.createdDate);
      if (!roomElement.querySelector(".unread-dot")) {
        const detailsElement =
          roomElement.querySelector(".room-item-details");
        if (detailsElement) {
          const dot = document.createElement("span");
          dot.className = "unread-dot";
          detailsElement.prepend(dot);
        }
      }
      roomList.prepend(roomElement);
    } else {
      loadChatRooms();
    }
  }
  function triggerImageUpload() {
    if (!currentChatId) return;
    document.getElementById("image-file-input").click();
  }
  async function handleImageSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
      const formData = new FormData();
      formData.append("image", file);
      const response = await fetch(
        `${window.location.origin}/api/chat/image`,
        { method: "POST", body: formData }
      );
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || "ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      const result = await response.json();
      sendImageMessage(result.imageUrl);
    } catch (error) {
      console.error("ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
      alert("ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    } finally {
      event.target.value = "";
    }
  }
  function sendImageMessage(imageUrl) {
    if (!websocket || websocket.readyState !== WebSocket.OPEN) {
      console.error("WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }
    const payload = {
      chatId: currentChatId,
      imageUrl: imageUrl,
      messageType: "IMAGE",
    };
    websocket.send(JSON.stringify(payload));
    displayMessage({
      senderId: currentUserId,
      imageUrl: imageUrl,
      createdDate: new Date().toISOString(),
      chatId: currentChatId,
      read: false,
      messageType: "IMAGE",
    });
  }
  function sendTextMessage() {
    if (!websocket || websocket.readyState !== WebSocket.OPEN) {
      console.error(
        "WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚"
      );
      return;
    }
    const messageInput = document.getElementById("message-input");
    const content = messageInput.value.trim();
    if (content === "") return;
    const payload = {
      chatId: currentChatId,
      content: content,
      messageType: "TEXT",
    };
    websocket.send(JSON.stringify(payload));
    displayMessage({
      senderId: currentUserId,
      content,
      createdDate: new Date().toISOString(),
      chatId: currentChatId,
      read: false,
      messageType: "TEXT",
    });
    messageInput.value = "";
  }
  function handleEnterKey(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      sendTextMessage();
    }
  }
  function formatMessageTime(isoString) {
    if (!isoString) return "";
    const date = new Date(isoString);
    const hours = date.getHours().toString().padStart(2, "0");
    const minutes = date.getMinutes().toString().padStart(2, "0");
    return `${hours}:${minutes}`;
  }

  function displayMessage(msg) {
    const chatWindow = document.getElementById("chat-window");
    const typeClass = msg.senderId === currentUserId ? "sent" : "received";

    // 1. ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ë¶„ê¸° ì²˜ë¦¬
    if (msg.messageType === "TRANSACTION_REQUEST") {
      if (msg.senderId === currentUserId) return;
      const requestData = JSON.parse(msg.content);
      const systemMsgContainer = document.createElement("div");
      systemMsgContainer.innerHTML = `
    <div class="transaction-request" id="request-${requestData.transactionId}">
      <p><strong>${requestData.buyerNickname}</strong>æ§˜ãŒè³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚</p>
      <div class="request-buttons">
        <button class="btn-approve" data-transaction-id="${requestData.transactionId}" data-action="APPROVED">æ‰¿èª</button>
        <button class="btn-reject" data-transaction-id="${requestData.transactionId}" data-action="REJECTED">æ‹’å¦</button>
      </div>
    </div>`;
      chatWindow.appendChild(systemMsgContainer);
    } else if (msg.messageType === "TRANSACTION_TYPE_SELECT") {
      const requestData = JSON.parse(msg.content);
      const systemMsgContainer = document.createElement("div");
      systemMsgContainer.innerHTML = `
    <div class="transaction-request" id="select-type-${requestData.transactionId}">
      <p><strong>å–å¼•æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</strong></p>
      <div class="request-buttons">
        <button class="btn-select-type" data-transaction-id="${requestData.transactionId}" data-value="DIRECT_TRADE">å¯¾é¢å–å¼•</button>
        <button class="btn-select-type" data-transaction-id="${requestData.transactionId}" data-value="DELIVERY_SERVICE">å®…é…ä¾¿</button>
      </div>
    </div>`;
      chatWindow.appendChild(systemMsgContainer);
    } else if (msg.messageType === "PAYMENT_METHOD_SELECT") {
      const requestData = JSON.parse(msg.content);
      const systemMsgContainer = document.createElement("div");
      systemMsgContainer.innerHTML = `
    <div class="transaction-request" id="select-payment-${requestData.transactionId}">
      <p><strong>æ±ºæ¸ˆæ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</strong></p>
      <div class="request-buttons">
        <button class="btn-select-payment" data-transaction-id="${requestData.transactionId}" data-delivery="DIRECT_TRADE" data-value="CARD">ã‚«ãƒ¼ãƒ‰</button>
        <button class="btn-select-payment" data-transaction-id="${requestData.transactionId}" data-delivery="DIRECT_TRADE" data-value="CASH">ç¾é‡‘</button>
      </div>
    </div>`;
      chatWindow.appendChild(systemMsgContainer);
    } else if (msg.messageType === "SHIPPING_INFO_REQUEST") {
      const requestData = JSON.parse(msg.content);
      const systemMsgContainer = document.createElement("div");
      systemMsgContainer.innerHTML = `
    <div class="transaction-request" id="shipping-request-${requestData.transactionId}">
      <p><strong>ãŠæ”¯æ‰•ã„ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>é…é€æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</strong></p>
      <div class="request-buttons">
        <button class="btn-open-shipping" data-transaction-id="${requestData.transactionId}">é…é€æƒ…å ±ã‚’å…¥åŠ›</button>
      </div>
    </div>`;
      chatWindow.appendChild(systemMsgContainer);
    } else if (msg.messageType === "PURCHASE_CONFIRM_REQUEST") {
      const requestData = JSON.parse(msg.content);
      const systemMsgContainer = document.createElement("div");
      systemMsgContainer.innerHTML = `
    <div class="transaction-request" id="confirm-purchase-${requestData.transactionId}">
      <p><strong>å•†å“ã‚’ç„¡äº‹å—ã‘å–ã‚Šã¾ã—ãŸã‹ï¼Ÿ<br>å–å¼•ã‚’å®Œäº†ã™ã‚‹ã«ã¯ã€Œè³¼å…¥ç¢ºå®šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</strong></p>
      <div class="request-buttons">
        <button class="btn-confirm-purchase" data-transaction-id="${requestData.transactionId}">è³¼å…¥ç¢ºå®š</button>
      </div>
    </div>`;
      chatWindow.appendChild(systemMsgContainer);
    } else if (msg.messageType === "REVIEW_REQUEST") {
      const requestData = JSON.parse(msg.content);
      const systemMsgContainer = document.createElement("div");
      systemMsgContainer.innerHTML = `
    <div class="transaction-request" id="review-request-${requestData.transactionId}">
      <p><strong>å–å¼•ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ<br>å‡ºå“è€…ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ®‹ã—ã¦ãã ã•ã„ï¼</strong></p>
      <div class="request-buttons">
        <button class="btn-write-review" data-transaction-id="${requestData.transactionId}">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ</button>
      </div>
    </div>`;
      chatWindow.appendChild(systemMsgContainer);
    } else if (msg.messageType === "CASH_PAYMENT_SELECTED") {
      const requestData = JSON.parse(msg.content);
      const systemMsgContainer = document.createElement("div");
      let buttonsHtml = "";
      if (currentUserId === requestData.sellerId) {
        // íŒë§¤ìì—ê²Œë§Œ ë²„íŠ¼ í‘œì‹œ
        buttonsHtml = `<div class="request-buttons"><button class="btn-hand-over" data-transaction-id="${requestData.transactionId}">å•†å“å—ã‘æ¸¡ã—å®Œäº†</button></div>`;
      }
      systemMsgContainer.innerHTML = `
    <div class="transaction-request" id="cash-selected-${requestData.transactionId}">
      <p><strong>ç¾é‡‘æ±ºæ¸ˆãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚<br>ä¼šã£ã¦å–å¼•ã™ã‚‹å ´æ‰€ã¨æ™‚é–“ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</strong></p>
      ${buttonsHtml}
    </div>`;
      chatWindow.appendChild(systemMsgContainer);
    } else if (msg.messageType === "ITEM_RECEIVED_CHECK") {
      if (msg.senderId === currentUserId) return; // êµ¬ë§¤ìì—ê²Œë§Œ í‘œì‹œ
      const requestData = JSON.parse(msg.content);
      const systemMsgContainer = document.createElement("div");
      systemMsgContainer.innerHTML = `
    <div class="transaction-request" id="receive-check-${requestData.transactionId}">
      <p><strong>å•†å“ã‚’ç„¡äº‹å—ã‘å–ã‚Šã¾ã—ãŸã‹ï¼Ÿ</strong></p>
      <div class="request-buttons">
        <button class="btn-item-received" data-transaction-id="${requestData.transactionId}">ã¯ã„ã€å—ã‘å–ã‚Šã¾ã—ãŸ</button>
      </div>
    </div>`;
      chatWindow.appendChild(systemMsgContainer);
    } else {
      // ì¼ë°˜ TEXT, IMAGE ë©”ì‹œì§€ ì²˜ë¦¬
      const containerEl = document.createElement("div");
      containerEl.className = `message-container ${typeClass}`;
      const msgEl = document.createElement("div");
      msgEl.className = `message ${typeClass}`;

      if (msg.messageType === "IMAGE") {
        const img = document.createElement("img");
        img.src = msg.imageUrl;
        img.alt = "ãƒãƒ£ãƒƒãƒˆç”»åƒ";
        img.onload = () => {
          chatWindow.scrollTop = chatWindow.scrollHeight;
        };
        msgEl.appendChild(img);
      } else {
        msgEl.textContent = msg.content;
      }

      const statusEl = document.createElement("div");
      statusEl.className = "message-status";
      if (typeClass === "sent" && !msg.read) {
        const unreadEl = document.createElement("span");
        unreadEl.className = "unread-indicator";
        unreadEl.textContent = "1";
        unreadEl.dataset.chatId = msg.chatId;
        statusEl.appendChild(unreadEl);
      }
      const timeEl = document.createElement("span");
      timeEl.className = "message-time";
      timeEl.textContent = formatMessageTime(msg.createdDate);
      statusEl.appendChild(timeEl);

      if (typeClass === "sent") {
        containerEl.appendChild(statusEl);
        containerEl.appendChild(msgEl);
      } else {
        containerEl.appendChild(msgEl);
        containerEl.appendChild(statusEl);
      }
      chatWindow.appendChild(containerEl);
    }
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  // [ì¶”ê°€] ì±„íŒ…ë°© ë‚˜ê°€ê¸° ë²„íŠ¼ì— ëŒ€í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
  function addLeaveButtonListener() {
    const leaveButton = document.getElementById("leave-chat-btn");
    if (!leaveButton) return; // ë²„íŠ¼ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ

    leaveButton.addEventListener("click", async () => {
      if (!currentChatId) {
        alert("ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      // ì‚¬ìš©ìì—ê²Œ ë‚˜ê°€ê¸° ì „ì— ì¬í™•ì¸ ë°›ìŠµë‹ˆë‹¤.
      const isConfirmed = confirm(
        "æœ¬å½“ã«ã“ã®ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ"
      );
      if (!isConfirmed) {
        return;
      }

      try {
        const response = await fetch(`/api/chat/${currentChatId}/leave`, {
          method: "POST",
        });

        if (response.ok) {
          alert("ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã—ãŸã€‚");
          // ì±„íŒ…ë°©ì„ ë‚˜ê°„ í›„, ì±„íŒ… ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•˜ê³  í˜„ì¬ ì±„íŒ…ì°½ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
          resetChatPanel(); // í˜„ì¬ ì—´ë ¤ìˆëŠ” ì±„íŒ…ì°½ ë‹«ê¸°
          loadChatRooms(); // ì±„íŒ… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
          // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
          const errorData = await response.json();
          alert(
            "ã‚¨ãƒ©ãƒ¼: " + (errorData.message || "é€€å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚")
          );
        }
      } catch (error) {
        console.error("ì±„íŒ…ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨:", error);
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const chatWindow = document.getElementById("chat-window");

    chatWindow.addEventListener("click", async function (event) {
      const target = event.target; // í´ë¦­ëœ ìš”ì†Œ

      if (target.matches(".btn-confirm-purchase")) {
        const transactionId = target.dataset.transactionId;
        if (
          !confirm(
            "è³¼å…¥ã‚’ç¢ºå®šã™ã‚‹ã¨ã€å–å¼•ãŒæœ€çµ‚çš„ã«çµ‚äº†ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ"
          )
        )
          return;
        try {
          const response = await fetch(
            `/api/transactions/${transactionId}/confirm`,
            { method: "POST" }
          );
          if (!response.ok)
            throw new Error(
              "è³¼å…¥ç¢ºå®šã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
            );
          target.closest(
            ".transaction-request"
          ).innerHTML = `<p><strong>è³¼å…¥ãŒç¢ºå®šã—ã¾ã—ãŸã€‚</strong></p>`;
        } catch (error) {
          alert(error.message);
        }
      } else if (target.matches(".btn-write-review")) {
        const transactionId = target.dataset.transactionId;
        window.open(
          `/review.html?transactionId=${transactionId}`,
          "reviewPopup",
          "width=500,height=650,scrollbars=yes,resizable=yes"
        );
        target.closest(
          ".transaction-request"
        ).innerHTML = `<p><strong>ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ãã¾ã—ãŸã€‚</strong></p>`;
      } else if (target.matches(".btn-open-shipping")) {
        const transactionId = target.dataset.transactionId;
        window.open(
          `/shipping.html?transactionId=${transactionId}`,
          "shippingPopup",
          "width=500,height=600,scrollbars=yes,resizable=yes"
        );
        //ì‚­ì œ?
        //target.closest(".transaction-request").innerHTML = `<p><strong>é…é€æƒ…å ±å…¥åŠ›ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ãã¾ã—ãŸã€‚</strong></p>`;
      } else if (
        target.matches(".btn-approve") ||
        target.matches(".btn-reject")
      ) {
        const transactionId = target.dataset.transactionId;
        const action = target.dataset.action;
        if (
          !confirm(
            `ã“ã®å–å¼•ã‚’ã€Œ${
              action === "APPROVED" ? "æ‰¿èª" : "æ‹’å¦"
            }ã€ã—ã¾ã™ã‹ï¼Ÿ`
          )
        )
          return;
        try {
          const response = await fetch(
            `/api/transactions/${transactionId}/approval`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ status: action }),
            }
          );
          if (!response.ok) throw new Error("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          alert(
            `å–å¼•ã‚’ã€Œ${action === "APPROVED" ? "æ‰¿èª" : "æ‹’å¦"}ã€ã—ã¾ã—ãŸã€‚`
          );
          const buttonContainer = target.closest(".request-buttons");
          if (action === "APPROVED") {
            buttonContainer.innerHTML = `<p><strong>æ‰¿èªã—ã¾ã—ãŸã€‚è³¼å…¥è€…ã®é¸æŠã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚</strong></p>`;
          } else {
            buttonContainer.innerHTML = `<p><strong>æ‹’å¦ã—ã¾ã—ãŸã€‚</strong></p>`;
          }
        } catch (error) {
          alert(error.message);
        }
      } else if (target.matches(".btn-select-type")) {
        const transactionId = target.dataset.transactionId;
        const selectedType = target.dataset.value;
        if (selectedType === "DELIVERY_SERVICE") {
          try {
            const response = await fetch(
              `/api/transactions/${transactionId}/type`,
              {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  deliveryService: "DELIVERY_SERVICE",
                  paymentMethod: "CARD",
                }),
              }
            );
            if (!response.ok) throw new Error("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            //ì‚­ì œí•´ë„ ë¨
            //target.closest(".transaction-request").innerHTML = `<p style="text-align:center; margin: 15px 0;"><strong>å®…é…ä¾¿ã‚’é¸æŠã—ã¾ã—ãŸã€‚æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚</strong></p>`;
            window.open(
              `/payment.html?transactionId=${transactionId}`,
              "paymentPopup",
              "width=500,height=700"
            );
          } catch (error) {
            alert(error.message);
          }
        } else if (selectedType === "DIRECT_TRADE") {
          target.closest(".transaction-request").innerHTML = `
        <p><strong>æ±ºæ¸ˆæ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</strong></p>
        <div class="request-buttons">
          <button class="btn-select-payment" data-transaction-id="${transactionId}" data-delivery="DIRECT_TRADE" data-value="CARD">ã‚«ãƒ¼ãƒ‰</button>
          <button class="btn-select-payment" data-transaction-id="${transactionId}" data-delivery="DIRECT_TRADE" data-value="CASH">ç¾é‡‘</button>
        </div>`;
        }
      } else if (target.matches(".btn-select-payment")) {
        const transactionId = target.dataset.transactionId;
        const deliveryType = target.dataset.delivery;
        const paymentType = target.dataset.value;
        try {
          const response = await fetch(
            `/api/transactions/${transactionId}/type`,
            {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                deliveryService: deliveryType,
                paymentMethod: paymentType,
              }),
            }
          );
          if (!response.ok) throw new Error("å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          const parentRequestDiv = target.closest(".transaction-request");
          if (paymentType === "CARD") {
            //ì‚­ì œ?
            //parentRequestDiv.innerHTML = `<p style="text-align:center; margin: 15px 0;"><strong>ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã‚’é¸æŠã—ã¾ã—ãŸã€‚æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚</strong></p>`;
            window.open(
              `/payment.html?transactionId=${transactionId}`,
              "paymentPopup",
              "width=500,height=700"
            );
          } else if (paymentType === "CASH") {
            parentRequestDiv.innerHTML = `<p style="text-align:center; margin: 15px 0;"><strong>ç¾é‡‘æ±ºæ¸ˆã‚’é¸æŠã—ã¾ã—ãŸã€‚</strong></p>`;
            if (websocket && websocket.readyState === WebSocket.OPEN) {
              const payload = {
                chatId: currentChatId,
                content: "ç¾é‡‘æ±ºæ¸ˆã‚’é¸æŠã—ã¾ã—ãŸã€‚",
                messageType: "TEXT",
              };
              websocket.send(JSON.stringify(payload));
              displayMessage({
                senderId: currentUserId,
                content: "ç¾é‡‘æ±ºæ¸ˆã‚’é¸æŠã—ã¾ã—ãŸã€‚",
                createdDate: new Date().toISOString(),
                messageType: "TEXT",
              });
            }
          }
        } catch (error) {
          alert(error.message);
        }
      } else if (target.matches(".btn-hand-over")) {
        const transactionId = target.dataset.transactionId;
        if (!confirm("è³¼å…¥è€…ã«å•†å“ã‚’æ¸¡ã—ã¾ã—ãŸã‹ï¼Ÿ")) return;
        try {
          const response = await fetch(
            `/api/transactions/${transactionId}/hand-over`,
            { method: "POST" }
          );
          if (!response.ok)
            throw new Error("å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
          target.closest(
            ".transaction-request"
          ).innerHTML = `<p><strong>è³¼å…¥è€…ã«å•†å“å—ã‘å–ã‚Šç¢ºèªã‚’è¦è«‹ã—ã¾ã—ãŸã€‚</strong></p>`;
        } catch (error) {
          alert(error.message);
        }
      } else if (target.matches(".btn-item-received")) {
        const transactionId = target.dataset.transactionId;
        try {
          const response = await fetch(
            `/api/transactions/${transactionId}/receive-item`,
            { method: "POST" }
          );
          if (!response.ok)
            throw new Error("å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
          target.closest(
            ".transaction-request"
          ).innerHTML = `<p><strong>å•†å“ã®å—ã‘å–ã‚Šã‚’ç¢ºèªã—ã¾ã—ãŸã€‚</strong></p>`;
        } catch (error) {
          alert(error.message);
        }
      }
    });
  });
</script>
</body>
</html>
