<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>クマケット | 会員退会</title>

  <link rel="stylesheet" th:href="@{/css/common/main.css}" />
  <link rel="stylesheet" th:href="@{/css/common/header.css}" />
  <link rel="stylesheet" th:href="@{/css/common/mypage.css}" />
  <link rel="stylesheet" th:href="@{/css/common/sidebar.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .withdrawal-content {
    padding: 12px;
    line-height: 1.5;
    font-size: 14px;
    color: var(--text-color);

    display: flex;
    flex-direction: column;
    align-items: center; /* 중앙 정렬 */
  }

  /* p 태그와 form은 섹션 폭 기준 꽉 채우기 */
  .withdrawal-content p,
  .withdrawal-content form {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .withdrawal-content p { margin-bottom: 16px; }

  .withdrawal-content .field {
    margin-bottom: 14px;
    display: flex;
    flex-direction: column;
  }

  .withdrawal-content .field input[type="password"] {
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    font-size: 14px;
  }

  .withdrawal-content .field.checkbox {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center; /* 중앙정렬 추가 */
    gap: 8px;
  }

  .withdrawal-content .actions {
    display: flex;
    gap: 10px;
    margin-top: 12px;
    justify-content: center;
  }

  .withdrawal-content .actions .btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: 1px solid var(--line);
    background: #fff;
    color: var(--text-color);
    font-weight: 600;
    text-align: center;
  }

  .withdrawal-content .actions .btn.primary {
    background: var(--primary-color);
    color: #fff;
    border-color: var(--primary-color);
  }

  .withdrawal-content .actions .btn.primary:hover {
    background: var(--primary-dark-color);
  }

  /* 섹션 기준폭에 맞추기 */
  section.withdraw-section {
    width: 640px;
    max-width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
  }

  .input:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(255,138,101,.18); }
  .danger{ color:#B00020; font-size:12.5px; }
  </style>
</head>
<body>

<!-- 헤더 -->
<div th:replace="fragments/header :: commonHeader"></div>

<main class="page">
  <!-- 사이드바 -->
  <div th:replace="fragments/sidebar :: commonSidebar"></div>

  <!-- 우측 콘텐츠: 회원탈퇴 -->
  <section class="section">
    <div class="section-head">
      <h2>会員退会</h2>
    </div>

    <div class="withdrawal-content">
      <p>退会するとアカウント情報は完全に削除され、復元できません。</p>

      <form th:action="@{/myPage/withdraw}" method="post" id="withdrawForm">
        <div class="field">
          <label for="pwd">パスワード確認</label>
          <input id="pwd" class="input" name="password" type="password" placeholder="パスワードを入力" required />
          <p class="danger" id="verifyError" style="display:none;">パスワードが一致しません。</p>
        </div>

        <div class="field checkbox">
          <input type="checkbox" id="confirm" required>
          <label for="confirm">上記内容を確認し、退会することに同意します。</label>
        </div>

        <div class="actions">
          <a th:href="@{/myPage}" class="btn">キャンセル</a>
          <button type="submit" class="btn primary">退会する</button>
        </div>

        <p class="danger" id="confirmError" style="display:none;">入力内容を確認してください。</p>
      </form>
    </div>
  </section>
</main>


<script>
  document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("withdrawForm");
    const pwdInput = document.getElementById("pwd");
    const confirm = document.getElementById("confirm");

    const verifyError = document.getElementById("verifyError");
    const confirmError = document.getElementById("confirmError");

    form.addEventListener("submit", function(e) {
      e.preventDefault();

      verifyError.style.display = "none";
      confirmError.style.display = "none";

      const pwd = pwdInput.value.trim();
      const isChecked = confirm.checked;

      if(!isChecked) {
        confirmError.style.display= "block";
        return;
      }

      fetch(form.action, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({ password: pwd })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.match) {
          verifyError.style.display = "block";
          return;
        }
        alert("アカウントが削除されました。");
        window.location.href = "/";
      })
      .catch(err => {
        console.error(err);
        alert("サーバーエラー");
      });
    });
  });
</script>

</body>
</html>
