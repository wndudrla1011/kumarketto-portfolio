<!DOCTYPE html>
<html lang="ja-JP" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
    <head>
        <meta charset="UTF-8" />
        <script th:src="@{/js/jquery-3.7.1.min.js}"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <!-- ## Font Awesome 링크 추가 ## -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
        <link rel="stylesheet" th:href="@{/css/products/updateForm.css}" />
        <title>상품 수정</title>
    </head>
    <body>
        <div class="form-container">
            <div class="form-header">
                <h1>商品情報の修正</h1>
                <p>商品の情報を修正後、下のボタンを押してください。</p>
            </div>
            <div th:if="${errors != null}">
                <ul class="error-list">
                    <li th:each="err : ${errors}" th:text="${err.defaultMessage}"></li>
                </ul>
            </div>

            <form th:action="@{/product/update}" th:object="${product}" method="post" enctype="multipart/form-data">
                <!-- Hidden Fields -->
                <input type="hidden" th:field="*{pid}" />
                <input type="hidden" th:field="*{userNo}" />
                <input type="hidden" th:field="*{status}" />
                <input type="hidden" id="newMainImageId" name="newMainImageId" />
                <input type="hidden" id="deletedImageIds" name="deletedImageIds" value="" />

                <div class="form-group">
                    <label for="name">商品名</label
                    ><input type="text" id="name" class="form-control" th:field="*{name}" required />
                </div>
                <div class="form-group">
                    <label for="category">カテゴリー</label
                    ><select id="category" class="form-control" th:field="*{categoryId}" required>
                        <option
                            th:each="c : ${product.categories}"
                            th:value="${c.categoryId}"
                            th:text="${c.categoryName}"
                        ></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="subCategory">サブカテゴリー</label
                    ><select id="subCategory" class="form-control" th:field="*{subcategoryId}" required>
                        <option
                            th:each="sc : ${product.subCategories}"
                            th:value="${sc.subcategoryId}"
                            th:text="${sc.subcategoryName}"
                        ></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="region">エリア</label
                    ><select id="region" class="form-control" th:field="*{selectedRegionId}" required>
                        <option th:each="r : ${product.regions}" th:value="${r.rgnId}" th:text="${r.rgnName}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="prefecture">都道府県</label
                    ><select id="prefecture" class="form-control" th:field="*{selectedPrefectureId}" required>
                        <option
                            th:each="pref : ${product.prefectures}"
                            th:value="${pref.prefId}"
                            th:text="${pref.prefName}"
                        ></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="municipality">市区町村</label
                    ><select id="municipality" class="form-control" th:field="*{municipalityId}" required>
                        <option
                            th:each="muni : ${product.municipalities}"
                            th:value="${muni.mId}"
                            th:text="${muni.muniName}"
                        ></option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="price">価格（円）</label
                    ><input type="number" id="price" class="form-control" th:field="*{price}" required />
                </div>

                <div class="form-group image-upload-section">
                    <label>商品画像（最大３枚）</label>
                    <div class="image-upload-grid">
                        <!-- 대표 이미지 -->
                        <div
                            class="image-box main-image-box"
                            th:classappend="${product.imageUrl != null} ? 'has-image'"
                        >
                            <div class="upload-placeholder" th:style="${product.imageUrl != null} ? 'display:none;'">
                                <i class="fa-solid fa-camera"></i><span>代表画像を変更</span>
                            </div>
                            <img
                                id="mainImagePreview"
                                class="preview"
                                th:src="${product.imageUrl}"
                                th:data-image-id="${product.mainImageId}"
                                th:style="${product.imageUrl == null} ? 'display:none;'"
                            />
                            <input type="file" name="mainUpload" id="mainUpload" accept="image/*" />
                            <div class="image-overlay"></div>
                        </div>

                        <!-- 상세 이미지 (기존 이미지) -->
                        <div th:each="img : ${product.detailImages}" class="image-box" th:classappend="'has-image'">
                            <div class="upload-placeholder" style="display: none">
                                <i class="fa-solid fa-plus"></i><span>詳細画像を追加</span>
                            </div>
                            <img class="preview" th:src="${img.imageUrl}" />
                            <input type="file" name="detailUploads" accept="image/*" />
                            <div class="image-overlay">
                                <button type="button" class="overlay-btn delete-btn" th:data-image-id="${img.imageId}">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                                <button
                                    type="button"
                                    class="overlay-btn set-main-btn"
                                    th:data-image-id="${img.imageId}"
                                >
                                    <i class="fa-solid fa-star"></i>
                                </button>
                            </div>
                        </div>

                        <!-- ## 여기가 핵심 수정 지점 ## -->
                        <!-- 상세 이미지 (빈 슬롯) -->
                        <div
                            th:if="${product.detailImages.size() < 2}"
                            th:each="i : ${#numbers.sequence(1, 2 - product.detailImages.size())}"
                            class="image-box"
                        >
                            <div class="upload-placeholder">
                                <i class="fa-solid fa-plus"></i><span>詳細画像を追加</span>
                            </div>
                            <img class="preview" style="display: none" />
                            <input type="file" name="detailUploads" accept="image/*" />
                            <div class="image-overlay">
                                <button type="button" class="overlay-btn delete-btn">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                                <button type="button" class="overlay-btn set-main-btn">
                                    <i class="fa-solid fa-star"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">商品の説明</label
                    ><textarea id="description" class="form-control" th:field="*{description}" required></textarea>
                </div>
                <button type="submit" class="submit-btn">修正を完了</button>
            </form>
        </div>

        <script>
            $(document).ready(function () {
                $("#category").change(function () {
                    const categoryId = $(this).val();
                    const $subCategory = $("#subCategory");
                    $subCategory.empty().append('<option value="" disabled selected>サブカテゴリーを選択</option>');
                    if (!categoryId) return;
                    $.get("/product/subcategories", { categoryId: categoryId }, function (subCategories) {
                        $.each(subCategories, (_, sub) => {
                            $subCategory.append($("<option>").val(sub.subcategoryId).text(sub.subcategoryName));
                        });
                    });
                });
                $("#region").change(function () {
                    const regionId = $(this).val();
                    const $prefecture = $("#prefecture");
                    const $municipality = $("#municipality");
                    $prefecture.empty().append('<option value="" disabled selected>都道府県を選択</option>');
                    $municipality.empty().append('<option value="" disabled selected>市区町村を選択</option>');
                    if (!regionId) return;
                    $.get("/product/prefectures", { regionId: regionId }, function (prefectures) {
                        $.each(prefectures, (_, prefObj) => {
                            $prefecture.append($("<option>").val(prefObj.prefId).text(prefObj.prefName));
                        });
                    });
                });
                $("#prefecture").change(function () {
                    const prefId = $(this).val();
                    const $muni = $("#municipality");
                    $muni.empty().append('<option value="" disabled selected>市区町村を選択</option>');
                    if (!prefId) return;
                    $.get("/product/municipalities", { prefectureId: prefId }, function (munis) {
                        $.each(munis, (_, muni) => {
                            $muni.append($("<option>").val(muni.mid).text(muni.muniName));
                        });
                    });
                });

                $(".image-upload-grid").on("change", 'input[type="file"]', function () {
                    const file = this.files[0];
                    const $parentBox = $(this).closest(".image-box");
                    const $previewImg = $parentBox.find("img.preview");
                    const $placeholder = $parentBox.find(".upload-placeholder");
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            $previewImg.attr("src", e.target.result).show();
                            $placeholder.hide();
                            $parentBox.addClass("has-image");
                        };
                        reader.readAsDataURL(file);
                    } else {
                        $previewImg.attr("src", "").hide();
                        $placeholder.show();
                        $parentBox.removeClass("has-image");
                    }
                });

                $(".image-upload-grid").on("click", ".delete-btn", function () {
                    const $parentBox = $(this).closest(".image-box");
                    const $fileInput = $parentBox.find('input[type="file"]');
                    const imageId = $(this).data("image-id");
                    if (imageId) {
                        const $hiddenInput = $("#deletedImageIds");
                        let currentIds = $hiddenInput.val() ? $hiddenInput.val().split(",") : [];
                        if (!currentIds.includes(String(imageId))) {
                            currentIds.push(imageId);
                            $hiddenInput.val(currentIds.join(","));
                            alert("削除されました。");
                        }
                    }
                    $fileInput.val("");
                    $fileInput.trigger("change");
                });

                $(".image-upload-grid").on("click", ".set-main-btn", function () {
                    const $detailBox = $(this).closest(".image-box");
                    const $mainBox = $(".main-image-box");

                    const $mainPreview = $mainBox.find("img.preview");
                    const $detailPreview = $detailBox.find("img.preview");
                    const mainSrc = $mainPreview.attr("src");
                    const detailSrc = $detailPreview.attr("src");

                    const $mainInput = $mainBox.find('input[type="file"]');
                    const $detailInput = $detailBox.find('input[type="file"]');
                    const mainFile = $mainInput[0].files[0];
                    const detailFile = $detailInput[0].files[0];

                    const mainImageId = $mainPreview.data("image-id");
                    const detailImageId = $(this).data("image-id");

                    // 1. UI(미리보기) 교체
                    $mainPreview.attr("src", detailSrc);
                    $detailPreview.attr("src", mainSrc);

                    // 2. Data(ID 및 File 객체) 교체
                    $mainPreview.data("image-id", detailImageId);
                    $(this).data("image-id", mainImageId);

                    const mainDataTransfer = new DataTransfer();
                    if (detailFile) mainDataTransfer.items.add(detailFile);
                    $mainInput[0].files = mainDataTransfer.files;

                    const detailDataTransfer = new DataTransfer();
                    if (mainFile) detailDataTransfer.items.add(mainFile);
                    $detailInput[0].files = detailDataTransfer.files;

                    // 3. 서버에 보낼 Hidden Input 값 설정
                    if (detailImageId) {
                        $("#newMainImageId").val(detailImageId);
                    } else {
                        $("#newMainImageId").val("");
                    }

                    alert("代表画像が変更されました。最終的な適用は「修正を完了」ボタンを押してください。");
                });
            });

            function validateForm() {
                const municipalityId = $("#municipality").val();
                if (!municipalityId || municipalityId === "") {
                    alert("市区町村を選択してください。");
                    return false;
                }
                return true;
            }
        </script>
    </body>
</html>
