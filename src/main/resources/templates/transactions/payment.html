<!DOCTYPE html>
<html lang="ja-JP" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>お支払い</title>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" th:href="@{/css/transactions/payment.css}" />
</head>
<body>
<div class="payment-container">
    <h3>お支払い情報の入力</h3>
    <form id="payment-form">
        <div class="form-group">
            <label for="card-number-element">カード番号</label>
            <div id="card-number-element" class="form-control"></div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="card-expiry-element">有効期限</label>
                <div id="card-expiry-element" class="form-control"></div>
            </div>
            <div class="form-group">
                <label for="card-cvc-element">CVC</label>
                <div id="card-cvc-element" class="form-control"></div>
            </div>
        </div>
        <div class="form-group">
            <label for="cardholder-name">カード名義人</label>
            <input
                    type="text"
                    id="cardholder-name"
                    class="form-control"
                    placeholder="TARO YAMADA"
                    required
            />
        </div>
        <button id="submit-payment-btn">支払う</button>
        <div id="error-message" role="alert"></div>
    </form>
</div>

<script>
    const stripe = Stripe(
        "pk_test_51S8IsDQwAWehLcOm6KHx6NsHnyFAytxVsjwphdqCDzDKphqKs1FQq7oFU14Lk1p8vXMNUH5sfmUPmZXfVuTTZ2RL00toPX0ePQ"
    );

    const urlParams = new URLSearchParams(window.location.search);
    const transactionId = urlParams.get("transactionId");

    const form = document.getElementById("payment-form");
    const submitButton = document.getElementById("submit-payment-btn");
    const errorMessageDiv = document.getElementById("error-message");

    if (!transactionId) {
        errorMessageDiv.textContent = "無効なアクセスです。取引IDがありません。";
    } else {
        fetch("/api/payments/intent", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ transactionId: transactionId }),
            credentials: "include", // 로그인 세션 쿠키 전송
        })
            .then((response) => {
                if (!response.ok) throw new Error("決済情報の読み込みに失敗しました。");
                return response.json();
            })
            .then((data) => {
                const clientSecret = data.clientSecret;
                const elements = stripe.elements({ clientSecret });

                const cardNumber = elements.create("cardNumber");
                cardNumber.mount("#card-number-element");
                const cardExpiry = elements.create("cardExpiry");
                cardExpiry.mount("#card-expiry-element");
                const cardCvc = elements.create("cardCvc");
                cardCvc.mount("#card-cvc-element");

                form.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    submitButton.disabled = true;
                    submitButton.textContent = "支払い処理中...";

                    const { error } = await stripe.confirmCardPayment(clientSecret, {
                        payment_method: {
                            card: cardNumber,
                            billing_details: { name: document.getElementById("cardholder-name").value },
                        },
                    });

                    if (error) {
                        errorMessageDiv.textContent = error.message;
                        submitButton.disabled = false;
                        submitButton.textContent = "支払う";
                    } else {
                        // 결제 성공 시, 수동 웹훅 API를 스스로 호출
                        document.body.innerHTML = `<div class="payment-container"><h2 style="color: green; text-align: center;">お支払い成功！</h2><p style="text-align: center;">サーバーの状態を更新しています...</p></div>`;

                        // fetch는 반환값을 기다리지 않고 즉시 다음으로 넘어갑니다. (fire and forget)
                        fetch(`/manual-webhook/${transactionId}`, {
                            credentials: "include",
                        }).then(() => {
                            // 3초 후 창을 닫아 메인 창의 폴링이 감지할 시간을 줍니다.
                            setTimeout(() => window.close(), 3000);
                        });
                    }
                });
            })
            .catch((error) => {
                errorMessageDiv.textContent = error.message;
            });
    }
</script>
</body>
</html>
</html>